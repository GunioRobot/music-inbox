{% extends "base.html" %}

{% block body_id %}home{% endblock %}

{% block body %}

<script type="text/javascript" src="{{MEDIA_URL}}js/jquery.validate.min.js"></script>
<script type="text/javascript" src="{{MEDIA_URL}}js/swfupload.js"></script>

<script type="text/javascript">

var swfu;
var ajaxLoader = '<img id="loader" src="{{MEDIA_URL}}img/loader.gif" alt="uploading" />';
var fileInQueue = null;
var validator, form, filePath, fileQueued, message;

$(function(){
    form = $("#frm_upload");
    filePath = $("#query");
    fileQueued = $("#file_queued");
    message = $("#message");
    
    // if no flash
    // FIXME: is there going to be a no flash state so this has a reason to exist?
    $("#id_file").change(function(){
        filePath.val($(this).val());
    });
    
});

window.onload = function() {
    var fileQueuedHandler = function(file) {
        if (fileInQueue) swfu.cancelUpload(fileInQueue.id, false);
        fileInQueue = file;
    }
    
    var fileDialogComplete = function() {
        if (fileInQueue) {
            var fileName = swfu.getFile().name;
            filePath.addClass("active").val(fileName);
            fileQueued.val("true");
            swfu.startUpload();
        }
    }
    
    var uploadStart = function() {
        form.addClass("uploading");
        if (message.length == 0) {
            form.prepend('<p id="message">Now uploading...</p>');
            message = $("#message");
        } else {
            message.removeClass("error").text('Now uploading...');
        }
    }
    
    var uploadSuccess = function(file, data, response) {
        json = $.parseJSON(data);
        form.removeClass("uploading");
        if (json.upload_success == 'true') {
            var url = "{% url library_success "0000" %}";
            window.location = url.replace('0000', json.library_id);
        } else {
            message.addClass("error").text(json.errors.file[0]);
        }
    }
    
    swfu = new SWFUpload({
        // debug: true,
        upload_url: "{% url api_library_upload %}",
        flash_url: "{{MEDIA_URL}}swf/swfupload.swf",
        
        // File Settings
        file_post_name: "file",
        file_queue_limit: "2",
        file_size_limit: "20 MB",
        file_types: "*.xml",
        
        // Button Settings
        button_placeholder_id: "btn_upload",
        button_width: 480,
        button_height: 50,
        button_window_mode: SWFUpload.WINDOW_MODE.TRANSPARENT,
        button_cursor: SWFUpload.CURSOR.HAND,
        button_action: SWFUpload.BUTTON_ACTION.SELECT_FILE,
        
        file_queued_handler: fileQueuedHandler,
        file_dialog_complete_handler: fileDialogComplete,
        upload_start_handler: uploadStart,
        upload_success_handler: uploadSuccess,
    });
};

</script>
<div id="document">
    <div id="topbar"></div>
    
    <h1>Music Inbox <span>Beta</span></h1>
    <p id="instructions">Upload your artists to learn about their latest releases.</p>
    <form name="frm_upload" id="frm_upload" method="post" action=".">
        <div class="input_container">
            <div class="overlay">
                <div id="btn_upload"></div>
            </div>
            <input type="text" name="query" id="query" value="Click to find your iTunes XML file" />
        </div>
        <input type="hidden" name="file_queued" value="false" id="file_queued" />
        <input type="submit" name="upload" id="btn_submit" value="Upload" />
    </form>
    
</div>

{% endblock %}